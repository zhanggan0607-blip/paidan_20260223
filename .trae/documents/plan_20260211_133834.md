# 代码质量改进实施计划

## 高优先级任务

### 1. 修复备品备件领用API 🔴
**问题**：当前API从`temporary_repair`表查询数据，将`remarks`字段映射为`productName`，设计不合理

**实施步骤**：
1. 创建新数据模型 `app/models/spare_parts_usage.py`
   - 字段：id, product_name, brand, model, quantity, user_name, issue_time, unit, project_id, project_name
   - 添加索引：idx_product_name, idx_user_name, idx_project_name
   
2. 创建Repository层 `app/repositories/spare_parts_usage.py`
   - 实现find_all（支持分页和筛选）
   - 实现create、update、delete方法
   
3. 创建Service层 `app/services/spare_parts_usage.py`
   - 实现业务逻辑
   
4. 修改API层 `app/api/v1/spare_parts.py`
   - 修改`/usage`端点，使用新的SparePartsUsage模型
   - 修复字段映射逻辑
   
5. 数据库迁移
   - 创建`spare_parts_usage`表
   - 迁移现有数据（如有）

### 2. 清理调试代码 🔴
**问题**：多个前端文件包含console.log调试代码，SparePartsIssue.vue包含未使用的导入

**实施步骤**：
1. 清理以下文件中的console.log：
   - `TemporaryRepairQuery.vue` (L272-296)
   - `MaintenancePlanManagement.vue`
   - `SpotWorkManagement.vue`
   - `StatisticsPage.vue`
   - `ProjectInfoManagement.vue`
   - `SparePartsManagement.vue`
   - `NearExpiryReminders.vue`

2. 移除未使用的导入：
   - `SparePartsIssue.vue` (L133): 移除`SparePartsIssueQueryParams`

### 3. 添加外键约束 🔴
**问题**：数据库表之间缺少外键约束，数据一致性无法保证

**实施步骤**：
1. 修改`app/models/temporary_repair.py`
   - 添加project_id外键：`ForeignKey('project_info.project_id')`
   - 添加maintenance_personnel外键关联（需修改personnel表添加name作为外键）

2. 修改`app/models/spot_work.py`
   - 添加project_id外键
   - 添加maintenance_personnel外键

3. 修改`app/models/maintenance_plan.py`
   - 添加project_id外键

4. 修改`app/models/periodic_inspection.py`
   - 添加project_id外键

5. 数据库迁移
   - 创建迁移脚本
   - 执行迁移

## 中优先级任务

### 4. 添加自定义异常类 🟡
**实施步骤**：
1. 创建`app/exceptions.py`
   - `BusinessException`: 业务异常基类
   - `NotFoundException`: 资源不存在异常
   - `ValidationException`: 参数验证异常
   - `DuplicateException`: 重复数据异常

2. 修改Service层
   - 使用自定义异常替代HTTPException
   - 统一异常处理

3. 修改API层
   - 添加全局异常处理器
   - 统一错误响应格式

### 5. 添加请求日志 🟡
**实施步骤**：
1. 在`app/main.py`中添加中间件
   - 记录请求方法、路径、参数
   - 记录响应状态码、处理时间

2. 在API层添加日志
   - 记录关键操作（创建、更新、删除）
   - 记录业务逻辑

### 6. 优化前端性能 🟡
**实施步骤**：
1. 添加虚拟滚动
   - 安装`vue-virtual-scroller`
   - 在大数据量列表中使用虚拟滚动

2. 优化key策略
   - 使用唯一标识符作为key
   - 避免使用index作为key

3. 添加防抖/节流
   - 搜索输入添加防抖
   - 滚动事件添加节流

## 低优先级任务

### 7. 添加单元测试 🟢
**实施步骤**：
1. 创建测试目录结构
2. 编写Repository层测试
3. 编写Service层测试
4. 编写API层测试

### 8. 添加API文档 🟢
**实施步骤**：
1. 使用FastAPI自动文档
2. 添加详细的描述和示例
3. 生成OpenAPI文档

### 9. 添加性能监控 🟢
**实施步骤**：
1. 添加响应时间监控
2. 添加数据库查询监控
3. 添加错误率监控

## 执行顺序建议

**第一阶段（立即执行）**：
1. 修复备品备件领用API
2. 清理调试代码

**第二阶段（本周内）**：
3. 添加外键约束
4. 添加自定义异常类
5. 添加请求日志

**第三阶段（下周）**：
6. 优化前端性能

**第四阶段（长期）**：
7. 添加单元测试
8. 添加API文档
9. 添加性能监控